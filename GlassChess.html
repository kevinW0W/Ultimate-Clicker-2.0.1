<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaxy Chess - Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #0a0a2e 0%, #000000 100%);
            font-family: 'Orbitron', sans-serif;
            color: white;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Galaxy Animation --- */
        .stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: url('https://www.transparenttextures.com/patterns/stardust.png');
            animation: drift 100s linear infinite;
        }

        @keyframes drift {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }

        .planet {
            position: absolute;
            border-radius: 50%;
            filter: blur(1px);
            z-index: -1;
            opacity: 0.4;
            animation: orbit linear infinite;
        }

        @keyframes orbit {
            from { transform: rotate(0deg) translateX(var(--dist)) rotate(0deg); }
            to { transform: rotate(360deg) translateX(var(--dist)) rotate(-360deg); }
        }

        .main-container {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            max-width: 95vw;
            max-height: 95vh;
            align-items: center;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            border-radius: 12px;
        }

        #board-wrapper {
            width: min(75vh, 85vw);
            height: min(75vh, 85vw);
            padding: 8px;
        }

        #board {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            grid-template-rows: repeat(8, 1fr);
            width: 100%;
            height: 100%;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .square {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
        }

        .square.white { background: rgba(255, 255, 255, 0.1); }
        .square.black { background: rgba(0, 0, 0, 0.4); }

        .square.highlight-last { background: rgba(255, 255, 0, 0.1) !important; }
        .square.highlight-check { background: radial-gradient(circle, rgba(255, 0, 0, 0.6) 0%, transparent 70%) !important; }

        .piece {
            width: 90%;
            height: 90%;
            z-index: 10;
            user-select: none;
            -webkit-user-drag: none;
        }

        .move-guide {
            width: 25%;
            height: 25%;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 50%;
            position: absolute;
            pointer-events: none;
        }

        .capture-guide {
            width: 80%;
            height: 80%;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: absolute;
            pointer-events: none;
        }

        .sidebar {
            width: 260px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            height: min(75vh, 85vw);
        }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; overflow-y: auto; padding: 20px; }
            .sidebar { width: min(75vh, 85vw); height: auto; }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        
        .btn-action {
            background: rgba(255,255,255,0.1);
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-action:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
        }
    </style>
</head>
<body>

    <div class="stars-container"></div>
    
    <div class="planet" style="width: 60px; height: 60px; background: radial-gradient(circle, #ff4e50, #f9d423); top: 10%; left: 5%; --dist: 100px; animation-duration: 40s;"></div>
    <div class="planet" style="width: 100px; height: 100px; background: radial-gradient(circle, #4facfe, #00f2fe); bottom: 10%; right: 5%; --dist: 180px; animation-duration: 55s;"></div>

    <!-- Mobile Block Overlay -->
    <div id="mobile-blocker" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-8 text-center">
        <div class="glass-panel p-8 max-w-sm">
            <div class="text-4xl mb-4">ðŸ›¸</div>
            <h2 class="text-xl font-bold text-cyan-400 mb-4 uppercase tracking-widest">Desktop Mode Required</h2>
            <p class="text-sm opacity-80 leading-relaxed mb-6">
                Galaxy Chess requires a larger display and mouse precision to navigate the cosmic board. 
                Please switch to a computer for the best experience.
            </p>
            <div class="text-[10px] opacity-40 uppercase">Safe Travels, Commander</div>
        </div>
    </div>

    <div class="main-container">
        <div class="flex flex-col items-center">
            <div id="board-wrapper" class="glass-panel">
                <div id="board"></div>
            </div>
        </div>

        <div class="sidebar">
            <div class="glass-panel p-4">
                <div class="flex justify-between items-center mb-4">
                    <div id="status-text" class="text-[10px] font-bold uppercase tracking-widest text-cyan-400">White's Turn</div>
                    <div class="flex gap-2">
                        <button id="guide-btn" title="Piece Guide" class="btn-action w-8 h-8 rounded flex items-center justify-center">?</button>
                        <button id="mute-btn" title="Mute" class="btn-action w-8 h-8 rounded flex items-center justify-center">ðŸ”Š</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-2 mb-4">
                    <label class="text-[9px] uppercase opacity-50">Opponent</label>
                    <select id="game-mode" class="bg-black/60 border border-white/10 p-2 w-full rounded outline-none text-[10px]">
                        <option value="2p">Local Player</option>
                        <option value="easy">Bot: Easy</option>
                        <option value="med">Bot: Medium</option>
                        <option value="hard">Bot: Hard</option>
                        <option value="extreme">Bot: Extreme</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button id="undo-btn" class="btn-action flex-1 py-2 rounded text-[10px] font-bold">UNDO</button>
                    <button id="reset-btn" class="btn-action flex-1 py-2 rounded text-[10px] font-bold text-red-400">RESET</button>
                </div>
            </div>

            <div class="glass-panel p-4 flex-grow flex flex-col overflow-hidden">
                <h2 class="text-[10px] font-bold mb-2 opacity-50 uppercase tracking-widest">Move History</h2>
                <div id="move-history" class="custom-scroll overflow-y-auto text-[10px] grid grid-cols-2 gap-x-2"></div>
            </div>
        </div>
    </div>

    <!-- Piece Guide Modal -->
    <div id="guide-modal" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto custom-scroll">
            <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                <h2 class="text-xl font-bold text-cyan-400">PIECE GUIDE</h2>
                <button onclick="toggleGuide()" class="text-2xl">&times;</button>
            </div>
            <div class="space-y-4 text-sm">
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg" class="w-10 h-10">
                    <div><strong>King:</strong> Moves 1 square in any direction. Don't let it get trapped!</div>
                </div>
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg" class="w-10 h-10">
                    <div><strong>Queen:</strong> Moves any number of squares diagonally, horizontally, or vertically.</div>
                </div>
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg" class="w-10 h-10">
                    <div><strong>Rook:</strong> Moves any number of squares horizontally or vertically.</div>
                </div>
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg" class="w-10 h-10">
                    <div><strong>Bishop:</strong> Moves any number of squares diagonally.</div>
                </div>
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg" class="w-10 h-10">
                    <div><strong>Knight:</strong> Moves in an 'L' shape. The only piece that can jump over others!</div>
                </div>
                <div class="flex items-center gap-4 bg-white/5 p-3 rounded">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg" class="w-10 h-10">
                    <div><strong>Pawn:</strong> Moves forward 1 square (or 2 on first move). Captures diagonally.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Modal -->
    <div id="game-over-modal" class="fixed inset-0 bg-black/90 hidden z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-8 text-center w-full max-w-xs">
            <h1 id="winner-text" class="text-2xl font-bold mb-2 text-cyan-400 uppercase">Game Over</h1>
            <p id="sub-winner-text" class="text-sm mb-6 opacity-70"></p>
            <button onclick="resetGame()" class="w-full bg-cyan-600 py-3 rounded-lg font-bold hover:bg-cyan-500 transition">PLAY AGAIN</button>
        </div>
    </div>

    <script>
        // Check for mobile on load
        function checkMobile() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const blocker = document.getElementById('mobile-blocker');
            if (isMobile) {
                blocker.classList.remove('hidden');
            }
        }

        const boardEl = document.getElementById('board');
        const statusEl = document.getElementById('status-text');
        const historyEl = document.getElementById('move-history');
        const gameModeEl = document.getElementById('game-mode');
        const muteBtn = document.getElementById('mute-btn');
        const undoBtn = document.getElementById('undo-btn');
        const guideBtn = document.getElementById('guide-btn');
        
        let game = new Chess();
        let selectedSquare = null;
        let isMuted = false;

        // Reliable open source sound effects
        const sounds = {
            move: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/Move.mp3'),
            capture: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/Capture.mp3'),
            check: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/Check.mp3'),
            castle: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/Castle.mp3'),
            gameover: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/GenericNotify.mp3'),
            undo: new Audio('https://raw.githubusercontent.com/lichess-org/lila/master/public/sound/standard/Move.mp3')
        };

        const pieceImages = {
            'p': 'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg',
            'r': 'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg',
            'n': 'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg',
            'b': 'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg',
            'q': 'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg',
            'k': 'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg',
            'P': 'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg',
            'R': 'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg',
            'N': 'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg',
            'B': 'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg',
            'Q': 'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg',
            'K': 'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'
        };

        function playSound(type) {
            if (isMuted) return;
            const audio = sounds[type];
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Sound play prevented or error:", e));
            }
        }

        function createBoard() {
            boardEl.innerHTML = '';
            for (let i = 0; i < 64; i++) {
                const square = document.createElement('div');
                const row = Math.floor(i / 8);
                const col = i % 8;
                const squareName = String.fromCharCode(97 + col) + (8 - row);
                square.classList.add('square');
                square.classList.add((row + col) % 2 === 0 ? 'white' : 'black');
                square.dataset.square = squareName;
                square.onclick = () => onSquareClick(squareName);
                boardEl.appendChild(square);
            }
            updateBoard();
        }

        function updateBoard() {
            const position = game.board();
            const squares = document.querySelectorAll('.square');
            squares.forEach(sq => {
                sq.innerHTML = '';
                sq.classList.remove('highlight-check', 'highlight-last');
            });

            if (game.in_check()) {
                const kingPos = findKing(game.turn());
                const kingSq = document.querySelector(`[data-square="${kingPos}"]`);
                if (kingSq) kingSq.classList.add('highlight-check');
            }

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const piece = position[r][c];
                    if (piece) {
                        const squareName = String.fromCharCode(97 + c) + (8 - r);
                        const sqEl = document.querySelector(`[data-square="${squareName}"]`);
                        if (sqEl) {
                            const img = document.createElement('img');
                            img.src = pieceImages[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                            img.classList.add('piece');
                            sqEl.appendChild(img);
                        }
                    }
                }
            }

            if (game.game_over()) {
                showGameOver();
            } else {
                statusEl.innerText = `${game.turn() === 'w' ? "White" : "Black"}'s Turn`;
                if (game.turn() === 'b' && gameModeEl.value !== '2p') {
                    setTimeout(makeBotMove, 500);
                }
            }
        }

        function onSquareClick(square) {
            if (game.game_over() || (game.turn() === 'b' && gameModeEl.value !== '2p')) return;
            const moves = game.moves({ square: square, verbose: true });
            if (selectedSquare === square) { clearSelection(); return; }

            if (selectedSquare) {
                const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
                if (move) {
                    handleMoveEffects(move);
                    clearSelection();
                    updateBoard();
                    return;
                }
            }

            const piece = game.get(square);
            if (piece && piece.color === game.turn()) {
                clearSelection();
                selectedSquare = square;
                const sqEl = document.querySelector(`[data-square="${square}"]`);
                if (sqEl) sqEl.classList.add('highlight-last');
                moves.forEach(m => {
                    const targetSq = document.querySelector(`[data-square="${m.to}"]`);
                    if (targetSq) {
                        const guide = document.createElement('div');
                        guide.classList.add(game.get(m.to) ? 'capture-guide' : 'move-guide');
                        targetSq.appendChild(guide);
                    }
                });
            } else {
                clearSelection();
            }
        }

        function handleMoveEffects(move) {
            if (move.flags.includes('c') || move.flags.includes('e')) playSound('capture');
            else if (move.flags.includes('k') || move.flags.includes('q')) playSound('castle');
            else playSound('move');
            if (game.in_check()) playSound('check');
            rebuildHistory();
        }

        function rebuildHistory() {
            historyEl.innerHTML = '';
            const history = game.history({ verbose: true });
            for (let i = 0; i < history.length; i += 2) {
                const moveNum = Math.floor(i / 2) + 1;
                const whiteMove = history[i].san;
                const blackMove = history[i + 1] ? history[i + 1].san : '';
                
                const div = document.createElement('div');
                div.classList.add('py-1', 'border-b', 'border-white/5', 'flex');
                div.innerHTML = `<span class="opacity-30 w-6">${moveNum}.</span> <span class="flex-1">${whiteMove}</span> <span class="flex-1">${blackMove}</span>`;
                historyEl.appendChild(div);
            }
            historyEl.scrollTop = historyEl.scrollHeight;
        }

        function clearSelection() {
            selectedSquare = null;
            document.querySelectorAll('.move-guide, .capture-guide').forEach(el => el.remove());
            document.querySelectorAll('.square').forEach(el => el.classList.remove('highlight-last'));
        }

        function findKing(color) {
            const board = game.board();
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    if (board[r][c]?.type === 'k' && board[r][c]?.color === color) return String.fromCharCode(97 + c) + (8 - r);
                }
            }
        }

        function evaluateBoard(gameInstance) {
            const weights = { p: 10, n: 30, b: 30, r: 50, q: 90, k: 900 };
            let score = 0;
            gameInstance.board().forEach(row => row.forEach(cell => {
                if (cell) score += (cell.color === 'w' ? weights[cell.type] : -weights[cell.type]);
            }));
            return score;
        }

        function minimax(gameInstance, depth, alpha, beta, isMaximizing) {
            if (depth === 0 || gameInstance.game_over()) return -evaluateBoard(gameInstance);
            const moves = gameInstance.moves();
            let bestValue = isMaximizing ? -Infinity : Infinity;
            for (let move of moves) {
                gameInstance.move(move);
                const value = minimax(gameInstance, depth - 1, alpha, beta, !isMaximizing);
                gameInstance.undo();
                if (isMaximizing) {
                    bestValue = Math.max(bestValue, value);
                    alpha = Math.max(alpha, bestValue);
                } else {
                    bestValue = Math.min(bestValue, value);
                    beta = Math.min(beta, bestValue);
                }
                if (beta <= alpha) break;
            }
            return bestValue;
        }

        function makeBotMove() {
            if (game.game_over()) return;
            const mode = gameModeEl.value;
            const moves = game.moves();
            let depth = mode === 'easy' ? 0 : (mode === 'med' ? 1 : (mode === 'hard' ? 2 : 3));
            
            if (depth === 0) {
                game.move(moves[Math.floor(Math.random() * moves.length)]);
            } else {
                let bestMove = null;
                let bestValue = Infinity;
                for (let m of moves) {
                    game.move(m);
                    let val = minimax(game, depth, -Infinity, Infinity, true);
                    game.undo();
                    if (val < bestValue) { bestValue = val; bestMove = m; }
                }
                game.move(bestMove || moves[0]);
            }
            const lastMove = game.history({verbose: true}).pop();
            if (lastMove) handleMoveEffects(lastMove);
            updateBoard();
        }

        function showGameOver() {
            playSound('gameover');
            const modal = document.getElementById('game-over-modal');
            modal.classList.remove('hidden');
            if (game.in_checkmate()) {
                document.getElementById('winner-text').innerText = "CHECKMATE";
                document.getElementById('sub-winner-text').innerText = `${game.turn() === 'w' ? "Black" : "White"} has claimed the galaxy.`;
            } else {
                document.getElementById('winner-text').innerText = "STALEMATE";
                document.getElementById('sub-winner-text').innerText = "The battle ends in a cosmic draw.";
            }
        }

        function resetGame() {
            game = new Chess();
            historyEl.innerHTML = '';
            document.getElementById('game-over-modal').classList.add('hidden');
            createBoard();
        }

        function toggleGuide() {
            document.getElementById('guide-modal').classList.toggle('hidden');
        }

        undoBtn.onclick = () => {
            game.undo();
            if (gameModeEl.value !== '2p') game.undo(); // Undo bot move too
            playSound('undo');
            clearSelection();
            rebuildHistory();
            updateBoard();
        };

        muteBtn.onclick = () => {
            isMuted = !isMuted;
            muteBtn.innerText = isMuted ? 'ðŸ”‡' : 'ðŸ”Š';
        };

        guideBtn.onclick = toggleGuide;
        document.getElementById('reset-btn').onclick = resetGame;
        
        window.onload = () => {
            checkMobile();
            createBoard();
        };
    </script>
</body>
</html>
